(()=>{"use strict";const e="http://127.0.0.1:8000/api/";document.addEventListener("DOMContentLoaded",(function(){!async function(){const o=await async function(){const o=e;try{const e=sessionStorage.getItem("token"),t=await fetch(o+"lotesNoClasificados",{headers:{Authorization:"Bearer "+e}});if(t.ok)return(await t.json()).lotes}catch(e){}}(),t=await async function(){const o=e;try{const e=sessionStorage.getItem("token"),t=await fetch(o+"componente",{headers:{Authorization:"Bearer "+e}});if(t.ok)return(await t.json()).componente}catch(e){console.error("Error al obtener los componentes:",e)}}(),n=$("#loteEntregado").DataTable();n.clear().draw(),o.forEach((o=>{const a=t.map((e=>`<option value="${e.id_comp}">${e.nombre}</option>`)).join(""),s=n.row.add([o.id_lote,o.latitud,o.longitud,o.estado,`<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#myModal${o.id_lote}"><i class="fas fa-edit"></i> Clasificar</button><button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgregar${o.id_lote}"><i class="fas fa-plus"></i> Despiezar</button>`]).draw(),d=`\n                <div class="modal" id="myModal${o.id_lote}">\n                    <div class="modal-dialog modal-md">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h4 class="modal-title">Modificar estado del lote</h4>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                            </div>\n                            <div class="modal-body">\n                                <form>\n                                    <div class="mb-3">\n                                        <label for="ubicacion" class="form-label">ID Lote:</label>\n                                        <input type="text" class="form-control" id="ubicacion" value="${o.id_lote}" readonly>\n                                    </div>\n\n                                    <div class="mb-3">\n                                    <label for="hwDropdown" class="form-label">Modificar el estado</label>\n                                    <select class="form-select" id="estadoDropdown" required>\n                                        <option>Clasificado</option>\n                                    </select>\n                                </div>\n                                </form>\n                            </div>\n                            <div class="modal-footer">\n                            <button type="button" class="btn btn-primary"  data-bs-dismiss="modal" id="modificarLoteBtn${o.id_lote}">Modificar</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `,i=`\n                <div class="modal" id="modalAgregar${o.id_lote}">\n                    <div class="modal-dialog modal-md">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h4 class="modal-title">Agregar componente de despiece</h4>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                            </div>\n                            <div class="modal-body">\n                                <form>\n                                    <div class="mb-3">\n                                        <label for="numLote" class="form-label">Numero lote:</label>\n                                        <input type="text" class="form-control" id="numLote" value="${o.id_lote}" readonly>\n                                    </div>\n                                    <div class="mb-3">\n                                        <label for="compDropdown" class="form-label">Componente</label>\n                                        <select class="form-select" id="compDropdown" required>\n                                            ${a}\n                                        </select>\n                                    </div>\n                                    <div class="mb-3">\n                                        <label for="cantidad" class="form-label">Cantidad:</label>\n                                        <input type="text" class="form-control" id="cantidad">\n                                    </div>\n\n                                    <div class="mb-3">\n                                        <label for="descripcion" class="form-label">Descripcion:</label>\n                                        <input type="text" class="form-control" id="descripcion">\n                                    </div>\n                                </form>\n                            </div>\n                            <div class="modal-footer">\n                                <button type="button" class="btn btn-success" data-bs-dismiss="modal" id="agregarDespiece${o.id_lote}" >Agregar</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;document.body.insertAdjacentHTML("beforeend",d),document.body.insertAdjacentHTML("beforeend",i),s.nodes().to$().data("lote",o),async function(o){document.getElementById(`modificarLoteBtn${o}`).addEventListener("click",(async()=>{const t=document.getElementById(`myModal${o}`),n=t.querySelector("#estadoDropdown"),a={estado:n.options[n.selectedIndex].value};await async function(o,t){const n=e;try{const e=sessionStorage.getItem("token"),a=await fetch(n+"despiece/"+o,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e},body:JSON.stringify(t)});if(a.ok){const e=await a.json();console.log("Lote clasificado correctamente:",e)}else console.error("Error al clasificar")}catch(e){}}(o,a),new bootstrap.Modal(t).hide()}))}(o.id_lote),async function(o){document.getElementById(`agregarDespiece${o}`).addEventListener("click",(async()=>{const t=document.getElementById(`modalAgregar${o}`),n=t.querySelector("#compDropdown");var a={id_comp:n.options[n.selectedIndex].value,cantidad:t.querySelector("#cantidad").value,descripcion:t.querySelector("#descripcion").value};console.log(a),await async function(o,t){const n=e,a=sessionStorage.getItem("token");try{const e=await fetch(n+"despiece/"+t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+a},body:JSON.stringify(o)});if(422==e.status){const o=await e.json(),t=new bootstrap.Modal(document.getElementById("errorModal")),n=document.getElementById("errorModalBody"),a=o.error.map((e=>`- ${e}`)).join("\n");n.innerText=a,t.show()}else{const e=new bootstrap.Modal(document.getElementById("successModal"));document.getElementById("successModalBody").innerText="El componente se ha aÃ±adido con exito ",e.show(),setTimeout((()=>{e.hide()}),1500)}}catch(e){}}(a,o),window.location.href="clasificacionLote.html",new bootstrap.Modal(t).hide(),t.querySelector("#cantidad").value="",t.querySelector("#descripcion").value=""}))}(o.id_lote)}))}()}))})();